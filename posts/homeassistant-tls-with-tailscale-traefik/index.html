<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS | ExitCode0</title>
<meta name=keywords content="docker,compose,traefik,tailscale,coredns,homeassistant"><meta name=description content="In previous posts, I&rsquo;ve explained how to use Tailscale&rsquo;s MagicDNS and HTTPS certificate feature to generate a TLS cert for your Home Assistant install: Homeassistant Enable MagicDNS and HTTPS Certificates in Tailscale. That setup required you to reformat the TLS cert and copy it to the Home Assistant container&mldr; it wouldn&rsquo;t be to much of a task to automate those actions, but fortunately there is now a superior method of applying and renewing a Tailscale cert for HASS (and many other self-hosted services). Let us dig in to that&mldr;"><meta name=author content="Tom"><link rel=canonical href=https://exitcode0.net/posts/homeassistant-tls-with-tailscale-traefik/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://exitcode0.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://exitcode0.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://exitcode0.net/favicon-32x32.png><link rel=apple-touch-icon href=https://exitcode0.net/apple-touch-icon.png><link rel=mask-icon href=https://exitcode0.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://exitcode0.net/posts/homeassistant-tls-with-tailscale-traefik/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7745507566538945" crossorigin=anonymous></script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=exit data-description="Support me on Buy me a coffee!" data-message="Buy me a coffee" data-color=#FF813F data-position=Right data-x_margin=18 data-y_margin=165></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EDE9MPZR9T"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EDE9MPZR9T")}</script><meta property="og:title" content="Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS"><meta property="og:description" content="In previous posts, I&rsquo;ve explained how to use Tailscale&rsquo;s MagicDNS and HTTPS certificate feature to generate a TLS cert for your Home Assistant install: Homeassistant Enable MagicDNS and HTTPS Certificates in Tailscale. That setup required you to reformat the TLS cert and copy it to the Home Assistant container&mldr; it wouldn&rsquo;t be to much of a task to automate those actions, but fortunately there is now a superior method of applying and renewing a Tailscale cert for HASS (and many other self-hosted services). Let us dig in to that&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://exitcode0.net/posts/homeassistant-tls-with-tailscale-traefik/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-07T17:00:00+01:00"><meta property="article:modified_time" content="2024-01-07T17:00:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS"><meta name=twitter:description content="In previous posts, I&rsquo;ve explained how to use Tailscale&rsquo;s MagicDNS and HTTPS certificate feature to generate a TLS cert for your Home Assistant install: Homeassistant Enable MagicDNS and HTTPS Certificates in Tailscale. That setup required you to reformat the TLS cert and copy it to the Home Assistant container&mldr; it wouldn&rsquo;t be to much of a task to automate those actions, but fortunately there is now a superior method of applying and renewing a Tailscale cert for HASS (and many other self-hosted services). Let us dig in to that&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://exitcode0.net/posts/"},{"@type":"ListItem","position":2,"name":"Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS","item":"https://exitcode0.net/posts/homeassistant-tls-with-tailscale-traefik/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS","name":"Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS","description":"In previous posts, I\u0026rsquo;ve explained how to use Tailscale\u0026rsquo;s MagicDNS and HTTPS certificate feature to generate a TLS cert for your Home Assistant install: Homeassistant Enable MagicDNS and HTTPS Certificates in Tailscale. That setup required you to reformat the TLS cert and copy it to the Home Assistant container\u0026hellip; it wouldn\u0026rsquo;t be to much of a task to automate those actions, but fortunately there is now a superior method of applying and renewing a Tailscale cert for HASS (and many other self-hosted services). Let us dig in to that\u0026hellip;\n","keywords":["docker","compose","traefik","tailscale","coredns","homeassistant"],"articleBody":"In previous posts, I’ve explained how to use Tailscale’s MagicDNS and HTTPS certificate feature to generate a TLS cert for your Home Assistant install: Homeassistant Enable MagicDNS and HTTPS Certificates in Tailscale. That setup required you to reformat the TLS cert and copy it to the Home Assistant container… it wouldn’t be to much of a task to automate those actions, but fortunately there is now a superior method of applying and renewing a Tailscale cert for HASS (and many other self-hosted services). Let us dig in to that…\nTailscale is a virtual private network (VPN) service that allows secure remote access to resources across different networks. It offers a feature called MagicDNS that enables you to access your resources using a domain name instead of an IP address. Additionally, you can use HTTPS certificates to encrypt traffic between clients and servers, ensuring secure communication. In this tutorial, we’ll explain how to enable MagicDNS and HTTPS certificates in Tailscale and how to add a TLS certificate to Home Assistant using Tailscale. The most practical benifit for using Home Assistant within a Tailscale network is that it removes the requirement for network port forwarding and exposing services publicly, whilst still allowing your devices to access it from outside your local network. This blog post aims to give you the starting stes required to setup MagicDNS and HTTPS certificates in Tailscale, create a certificate on your home server and install that certificate in a Home Assistant docker container.\nWHY?! Why do I want a valid TLS certificate and a HTTPS connection to Home Assistant without a browser warning? Per the 2023.5 relase (https://www.home-assistant.io/blog/2023/05/03/release-20235/) voice control is all the rage using local voice assistants; in order to use the microphone in a modern browser connected to you Home Assistant dashboard, you need to have a valid HTTPS connection!\nEnabling MagicDNS Sign in to your Tailscale admin console and select your network. Click on “Nodes” and select the node that you want to enable MagicDNS for (You might only have one default node like me). Under “DNS” click “Enable MagicDNS.” Once you’ve enabled MagicDNS, you can access your devices using the tailnet domain allocated to your network. For example, mypc.exampletail.ts.net, where mypc is the device name.\nEnabling HTTPS Certificates Navigate to the DNS page of the admin console. Under HTTPS Certificates, click Enable HTTPS. Acknowledge that your machine names and your tailnet name will be published on a public ledger. Configure Tailnet Nameservers With MagicDNS enabled, we need to turn on splitDNS and set the nameserver to the Tailnet IP of the host which will be running our CoreDNS container - Yes, you need to have your docker host on your tailnet for this to work.\nHere is what you should end up with:\nThis is where things change from the previous post. This method is slightly more complex, as it required the adition of a Traefik and CoreDNS container, but once it is configured, it is exponentially more effective and scales well to other services.\nYou are going to need a domain that you own and that you can control the DNS configuration of. This setup is using the Certbot DNS-01 Challenge. This challenge asks you to prove that you control the DNS for your domain name by putting a specific value in a TXT record under that domain name. The easiest was to get your domain ready for DNS-01 is using cloudflare, but this is beyond the scope of the post. The best guide I could find for cloudflare, DNS-01 readiness is here: How to create Let’s Encrypt certificate using Cloudflare API token. This API token is essential and referenced below in our Traefik Docker Compose yaml file.\nCoreDNS Docker Compose version: '3' services: coredns: image: coredns/coredns:1.11.1 container_name: coredns restart: always dns: 127.0.0.1 ports: - 53:53/udp volumes: - ./config:/root/ command: -conf /root/Corefile Inside our config directory, we have a corefile which holds the DNS records we need.\nCoreDNS Config File . { forward . 8.8.8.8 9.9.9.9 log errors } { forward . 8.8.8.8 9.9.9.9 } auto { root /root file zones/.zone prometheus errors log } If like me, you have some A records which point to public services and you don’t want lookups for these subdomains to be done in CoreDNS, you need to instruct CoreDNS to forward them; in this case the lookup is forwarded to 8.8.8.8 (or 9.9.9.9).\nCoreDNS Zone File This is the file listed in our config file:\nfile zones/.zone Our .zone file should look like this:\n$TTL 300 ; generated with dnscontrol 2023-11-14T21:02:31Z @ 3600 IN SOA sns.dns.icann.org. noc.dns.icann.org. 2023111400 7200 3600 1209600 3600 IN NS ns1.example.com. IN NS ns2.example.com. IN NS ns3.example.com. IN NS ns4.example.com. home IN A www IN A 127.0.0.1 IN AAAA ::1 This config assumes that your Home Assistant container is running on the same Tailnet host as CoreDNS and Traefik.\nTraefik Docker Compose version: \"3\" services: traefik: container_name: traefik image: traefik:v2.10 labels: - traefik.enable=true - traefik.docker.network=traefik_proxy ports: - \"80:80\" - \"443:443\" volumes: - \"/var/run/docker.sock:/var/run/docker.sock\" - \"./certs:/letsencrypt\" - \"./traefik.yml:/etc/traefik/traefik.yml\" - \"./dynamic.yml:/etc/traefik/dynamic.yml\" restart: unless-stopped environment: - \"CF_API_EMAIL=\" - \"CF_API_KEY=\" networks: - traefik_proxy networks: traefik_proxy: external: true Traefik Config YAML files We need these two yaml files which are reference in the compose file as they define some important settings within Traefik’s running configuration.\ntraefik.yml entryPoints: http: address: \":80\" http: redirections: entryPoint: to: https scheme: https https: address: \":443\" serversTransport: insecureSkipVerify: true providers: docker: endpoint: \"unix:///var/run/docker.sock\" exposedByDefault: false file: directory: /etc/traefik/ certificatesResolvers: le: acme: email: storage: /letsencrypt/acme.json dnschallenge: provider: cloudflare resolvers: - \"1.1.1.1:53\" log: level: debug dynamic.yml tls: options: default: minVersion: VersionTLS12 cipherSuites: - TLS_AES_128_GCM_SHA256 - TLS_CHACHA20_POLY1305_SHA256 - TLS_AES_256_GCM_SHA384 - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256 - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 Home Assistant Docker Compose All that is left is to configure our Home Assistant container to use Traefik as a proxy. This is done by setting labels:\nversion: '3' services: homeassistant: container_name: homeassistant image: \"ghcr.io/home-assistant/home-assistant:stable\" volumes: - ./data:/config - /etc/localtime:/etc/localtime:ro restart: unless-stopped labels: - \"traefik.enable=true\" - \"traefik.docker.network=traefik_proxy\" - \"traefik.http.routers.home.entrypoints=https\" - \"traefik.http.routers.home.rule=Host(`home.`)\" - \"traefik.http.routers.home.tls.certresolver=le\" - \"traefik.http.services.home.loadbalancer.server.port=8123\" networks: - traefik_proxy networks: traefik_proxy: external: true Now all that’s left is to bring all our containers up; in the following order: CoreDNS \u003e Traefik \u003e HomeAssistant.\ndocker compose up -d This post uses Docker Compose V2, if you are still using V1, consider upgrading otherwise use docker-compose instead of docker compose.\nPlease note that we MUST use the traefik_proxy docker network; this essentialls means that all trafic destined for the Home Assistant web application, routes through Traefik.\nAs an added bonus, this means that we can access our love lace dashboards without the :8123 port in the URL. The even more exciting thing is, we can now enable Mic usage in our browser, which means we are ready to make the most of all the great voice assistant feature that the HA developers have been working on: Home Assistant voice control.\nConclusion These Docker Compose file seamlessly integrates Home Assistant with Traefik, providing a flexible and scalable solution for managing home automation services with secure access through Traefik’s reverse proxy capabilities. The use of labels in Traefik configuration enhances the control and routing capabilities, making it an efficient and secure setup for Home Assistant deployment.\n","wordCount":"1195","inLanguage":"en","datePublished":"2024-01-07T17:00:00+01:00","dateModified":"2024-01-07T17:00:00+01:00","author":{"@type":"Person","name":"Tom"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://exitcode0.net/posts/homeassistant-tls-with-tailscale-traefik/"},"publisher":{"@type":"Organization","name":"ExitCode0","logo":{"@type":"ImageObject","url":"https://exitcode0.net/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://exitcode0.net/ accesskey=h title="ExitCode0 (Alt + H)">ExitCode0</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://datasolace.com/ title=DataSolace><span>DataSolace</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://exitcode0.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://exitcode0.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://exitcode0.net/privacy/ title=Privacy><span>Privacy</span></a></li><li><a href=https://exitcode0.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://exitcode0.net/>Home</a>&nbsp;»&nbsp;<a href=https://exitcode0.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Home Assistant HTTPS Certificates with Tailscale, Traefik and CoreDNS</h1><div class=post-meta><span title='2024-01-07 17:00:00 +0100 +0100'>January 7, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Tom</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#enabling-magicdns aria-label="Enabling MagicDNS">Enabling MagicDNS</a></li><li><a href=#enabling-https-certificates aria-label="Enabling HTTPS Certificates">Enabling HTTPS Certificates</a></li><li><a href=#configure-tailnet-nameservers aria-label="Configure Tailnet Nameservers">Configure Tailnet Nameservers</a></li><li><a href=#coredns-docker-compose aria-label="CoreDNS Docker Compose">CoreDNS Docker Compose</a><ul><li><a href=#coredns-config-file aria-label="CoreDNS Config File">CoreDNS Config File</a></li><li><a href=#coredns-zone-file aria-label="CoreDNS Zone File">CoreDNS Zone File</a></li></ul></li><li><a href=#traefik-docker-compose aria-label="Traefik Docker Compose">Traefik Docker Compose</a><ul><li><a href=#traefik-config-yaml-files aria-label="Traefik Config YAML files">Traefik Config YAML files</a><ul><li><a href=#traefikyml aria-label=traefik.yml>traefik.yml</a></li><li><a href=#dynamicyml aria-label=dynamic.yml>dynamic.yml</a></li></ul></li></ul></li><li><a href=#home-assistant-docker-compose aria-label="Home Assistant Docker Compose">Home Assistant Docker Compose</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul></div></details></div><div class=post-content><p>In previous posts, I&rsquo;ve explained how to use Tailscale&rsquo;s MagicDNS and HTTPS certificate feature to generate a TLS cert for your Home Assistant install: <a href=../homeassistant-tls-with-tailscale>Homeassistant Enable MagicDNS and HTTPS Certificates in Tailscale</a>. That setup required you to reformat the TLS cert and copy it to the Home Assistant container&mldr; it wouldn&rsquo;t be to much of a task to automate those actions, but fortunately there is now a superior method of applying and renewing a Tailscale cert for HASS (and many other self-hosted services). Let us dig in to that&mldr;</p><p>Tailscale is a virtual private network (VPN) service that allows secure remote access to resources across different networks. It offers a feature called MagicDNS that enables you to access your resources using a domain name instead of an IP address. Additionally, you can use HTTPS certificates to encrypt traffic between clients and servers, ensuring secure communication. In this tutorial, we&rsquo;ll explain how to enable MagicDNS and HTTPS certificates in Tailscale and how to add a TLS certificate to Home Assistant using Tailscale.
The most practical benifit for using Home Assistant within a Tailscale network is that it removes the requirement for network port forwarding and exposing services publicly, whilst still allowing your devices to access it from outside your local network. This blog post aims to give you the starting stes required to setup MagicDNS and HTTPS certificates in Tailscale, create a certificate on your home server and install that certificate in a Home Assistant docker container.</p><p><strong>WHY?!</strong> Why do I want a valid TLS certificate and a HTTPS connection to Home Assistant without a browser warning? Per the 2023.5 relase (<a href=https://www.home-assistant.io/blog/2023/05/03/release-20235/>https://www.home-assistant.io/blog/2023/05/03/release-20235/</a>) voice control is all the rage using local voice assistants; in order to use the microphone in a modern browser connected to you Home Assistant dashboard, you need to have a valid HTTPS connection!</p><h2 id=enabling-magicdns>Enabling MagicDNS<a hidden class=anchor aria-hidden=true href=#enabling-magicdns>#</a></h2><ol><li>Sign in to your Tailscale admin console and select your network.</li><li>Click on &ldquo;Nodes&rdquo; and select the node that you want to enable MagicDNS for (You might only have one default node like me).</li><li>Under &ldquo;DNS&rdquo; click &ldquo;Enable MagicDNS.&rdquo;</li></ol><p>Once you&rsquo;ve enabled MagicDNS, you can access your devices using the tailnet domain allocated to your network. For example, <code>mypc.exampletail.ts.net</code>, where <code>mypc</code> is the device name.</p><h2 id=enabling-https-certificates>Enabling HTTPS Certificates<a hidden class=anchor aria-hidden=true href=#enabling-https-certificates>#</a></h2><ol><li>Navigate to the DNS page of the admin console.</li><li>Under HTTPS Certificates, click Enable HTTPS.</li><li>Acknowledge that your machine names and your tailnet name will be published on a public ledger.</li></ol><p><img loading=lazy src=/images/tailscale-https-certificates.png alt="HTTPS enabled in the Tailscale admin console"></p><h2 id=configure-tailnet-nameservers>Configure Tailnet Nameservers<a hidden class=anchor aria-hidden=true href=#configure-tailnet-nameservers>#</a></h2><p>With MagicDNS enabled, we need to turn on splitDNS and set the nameserver to the Tailnet IP of the host which will be running our CoreDNS container - Yes, you need to have your docker host on your tailnet for this to work.</p><p>Here is what you should end up with:</p><p><img loading=lazy src=/images/tailscale-nameservers.png alt="HTTPS Connection to Home Assistant over Tailscale"></p><hr><p>This is where things change from the previous post. This method is slightly more complex, as it required the adition of a Traefik and CoreDNS container, but once it is configured, it is exponentially more effective and scales well to other services.</p><p>You are going to need a domain that you own and that you can control the DNS configuration of. This setup is using the <a href=https://letsencrypt.org/docs/challenge-types/#dns-01-challenge>Certbot DNS-01 Challenge</a>. This challenge asks you to prove that you control the DNS for your domain name by putting a specific value in a TXT record under that domain name. The easiest was to get your domain ready for DNS-01 is using cloudflare, but this is beyond the scope of the post. The best guide I could find for cloudflare, DNS-01 readiness is here: <a href=https://silicon.blog/2023/05/17/how-to-create-lets-encrypt-certificate-using-cloudflare-api-token/>How to create Let’s Encrypt certificate using Cloudflare API token</a>. This API token is essential and referenced below in our Traefik Docker Compose yaml file.</p><h2 id=coredns-docker-compose>CoreDNS Docker Compose<a hidden class=anchor aria-hidden=true href=#coredns-docker-compose>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>coredns</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>image</span>: <span style=color:#ae81ff>coredns/coredns:1.11.1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>coredns</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dns</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>53</span>:<span style=color:#ae81ff>53</span><span style=color:#ae81ff>/udp</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>./config:/root/</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>command</span>: -<span style=color:#ae81ff>conf /root/Corefile</span>
</span></span></code></pre></div><p>Inside our config directory, we have a corefile which holds the DNS records we need.</p><h3 id=coredns-config-file>CoreDNS Config File<a hidden class=anchor aria-hidden=true href=#coredns-config-file>#</a></h3><pre tabindex=0><code>. {
    forward . 8.8.8.8 9.9.9.9
    log
    errors
}
&lt;ignored-subdomain.domain.tld&gt; {
    forward . 8.8.8.8 9.9.9.9
}
auto &lt;domain.tld&gt; {
    root /root
    file zones/&lt;domain.tld&gt;.zone
    prometheus
    errors
    log
}
</code></pre><blockquote><p>If like me, you have some A records which point to public services and you don&rsquo;t want lookups for these subdomains to be done in CoreDNS, you need to instruct CoreDNS to forward them; in this case the lookup is forwarded to 8.8.8.8 (or 9.9.9.9).</p></blockquote><h3 id=coredns-zone-file>CoreDNS Zone File<a hidden class=anchor aria-hidden=true href=#coredns-zone-file>#</a></h3><p>This is the file listed in our config file:</p><pre tabindex=0><code>file zones/&lt;domain.tld&gt;.zone
</code></pre><p>Our <code>&lt;domain.tld>.zone</code> file should look like this:</p><pre tabindex=0><code>$TTL 300
; generated with dnscontrol 2023-11-14T21:02:31Z
@          3600  IN SOA   sns.dns.icann.org. noc.dns.icann.org. 2023111400 7200 3600 1209600 3600
                 IN NS    ns1.example.com.
                 IN NS    ns2.example.com.
                 IN NS    ns3.example.com.
                 IN NS    ns4.example.com.
home             IN A     &lt;your_docker_host_tailnet_IP&gt;
www              IN A     127.0.0.1
                 IN AAAA  ::1
</code></pre><p>This config assumes that your Home Assistant container is running on the same Tailnet host as CoreDNS and Traefik.</p><h2 id=traefik-docker-compose>Traefik Docker Compose<a hidden class=anchor aria-hidden=true href=#traefik-docker-compose>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>traefik</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>traefik:v2.10</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik.enable=true</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik.docker.network=traefik_proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;80:80&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;443:443&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;/var/run/docker.sock:/var/run/docker.sock&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;./certs:/letsencrypt&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;./traefik.yml:/etc/traefik/traefik.yml&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;./dynamic.yml:/etc/traefik/dynamic.yml&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;CF_API_EMAIL=&lt;your_email_address&gt;&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;CF_API_KEY=&lt;your_cloudflare_API_key&gt;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik_proxy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik_proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h3 id=traefik-config-yaml-files>Traefik Config YAML files<a hidden class=anchor aria-hidden=true href=#traefik-config-yaml-files>#</a></h3><p>We need these two yaml files which are reference in the compose file as they define some important settings within Traefik&rsquo;s running configuration.</p><h4 id=traefikyml>traefik.yml<a hidden class=anchor aria-hidden=true href=#traefikyml>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>entryPoints</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#34;:80&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>redirections</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>entryPoint</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>to</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>scheme</span>: <span style=color:#ae81ff>https</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>https</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#34;:443&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>serversTransport</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>insecureSkipVerify</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>providers</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>docker</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>endpoint</span>: <span style=color:#e6db74>&#34;unix:///var/run/docker.sock&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>exposedByDefault</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>file</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>directory</span>: <span style=color:#ae81ff>/etc/traefik/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>certificatesResolvers</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>le</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>acme</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>email</span>: <span style=color:#ae81ff>&lt;your_email_address&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>storage</span>: <span style=color:#ae81ff>/letsencrypt/acme.json</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>dnschallenge</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>cloudflare</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resolvers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#e6db74>&#34;1.1.1.1:53&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>log</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>level</span>: <span style=color:#ae81ff>debug</span>
</span></span></code></pre></div><h4 id=dynamicyml>dynamic.yml<a hidden class=anchor aria-hidden=true href=#dynamicyml>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>tls</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>options</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>default</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>minVersion</span>: <span style=color:#ae81ff>VersionTLS12</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>cipherSuites</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>TLS_AES_128_GCM_SHA256</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>TLS_CHACHA20_POLY1305_SHA256</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>TLS_AES_256_GCM_SHA384</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span>
</span></span></code></pre></div><h2 id=home-assistant-docker-compose>Home Assistant Docker Compose<a hidden class=anchor aria-hidden=true href=#home-assistant-docker-compose>#</a></h2><p>All that is left is to configure our Home Assistant container to use Traefik as a proxy. This is done by setting labels:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;3&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>homeassistant</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>homeassistant</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;ghcr.io/home-assistant/home-assistant:stable&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./data:/config</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/etc/localtime:/etc/localtime:ro</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.docker.network=traefik_proxy&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.home.entrypoints=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.home.rule=Host(`home.&lt;youdomain.tld&gt;`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.home.tls.certresolver=le&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.home.loadbalancer.server.port=8123&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>traefik_proxy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>traefik_proxy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>Now all that&rsquo;s left is to bring all our containers up; in the following order: <strong>CoreDNS > Traefik > HomeAssistant</strong>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker compose up -d
</span></span></code></pre></div><blockquote><p>This post uses Docker Compose V2, if you are still using V1, consider upgrading otherwise use <code>docker-compose</code> instead of <code>docker compose</code>.</p></blockquote><p>Please note that we <strong>MUST</strong> use the <code>traefik_proxy</code> docker network; this essentialls means that all trafic destined for the Home Assistant web application, routes through Traefik.</p><p>As an added bonus, this means that we can access our love lace dashboards without the :8123 port in the URL. The even more exciting thing is, we can now enable Mic usage in our browser, which means we are ready to make the most of all the great voice assistant feature that the HA developers have been working on: <a href=https://www.home-assistant.io/voice_control/>Home Assistant voice control</a>.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>These Docker Compose file seamlessly integrates Home Assistant with Traefik, providing a flexible and scalable solution for managing home automation services with secure access through Traefik&rsquo;s reverse proxy capabilities. The use of labels in Traefik configuration enhances the control and routing capabilities, making it an efficient and secure setup for Home Assistant deployment.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://exitcode0.net/tags/docker/>Docker</a></li><li><a href=https://exitcode0.net/tags/compose/>Compose</a></li><li><a href=https://exitcode0.net/tags/traefik/>Traefik</a></li><li><a href=https://exitcode0.net/tags/tailscale/>Tailscale</a></li><li><a href=https://exitcode0.net/tags/coredns/>Coredns</a></li><li><a href=https://exitcode0.net/tags/homeassistant/>Homeassistant</a></li></ul><nav class=paginav><a class=prev href=https://exitcode0.net/posts/generating-artwork-with-stable-diffusion-april-2024/><span class=title>« Prev</span><br><span>Generating Artwork With Stable Diffusion - April 2024 Edition</span>
</a><a class=next href=https://exitcode0.net/posts/python-development-in-docker-containers/><span class=title>Next »</span><br><span>Python Development in Docker Containers</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://exitcode0.net/>ExitCode0</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>