<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Testing Llama3 With LM Studio | ExitCode0</title>
<meta name=keywords content="stable-diffusion,AI,art"><meta name=description content="Taking a look at the the latest open source llama 3 model after its April 2024 release. Testing its performance and accuracy with LM Studio."><meta name=author content="Tom"><link rel=canonical href=https://exitcode0.net/posts/testing-llama3-with-lmstudio/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://exitcode0.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://exitcode0.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://exitcode0.net/favicon-32x32.png><link rel=apple-touch-icon href=https://exitcode0.net/apple-touch-icon.png><link rel=mask-icon href=https://exitcode0.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://exitcode0.net/posts/testing-llama3-with-lmstudio/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7745507566538945" crossorigin=anonymous></script><script data-name=BMC-Widget data-cfasync=false src=https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js data-id=exit data-description="Support me on Buy me a coffee!" data-message="Buy me a coffee" data-color=#FF813F data-position=Right data-x_margin=18 data-y_margin=165></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-EDE9MPZR9T"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-EDE9MPZR9T")}</script><meta property="og:title" content="Testing Llama3 With LM Studio"><meta property="og:description" content="Taking a look at the the latest open source llama 3 model after its April 2024 release. Testing its performance and accuracy with LM Studio."><meta property="og:type" content="article"><meta property="og:url" content="https://exitcode0.net/posts/testing-llama3-with-lmstudio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-19T07:00:00+01:00"><meta property="article:modified_time" content="2024-04-19T07:00:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Testing Llama3 With LM Studio"><meta name=twitter:description content="Taking a look at the the latest open source llama 3 model after its April 2024 release. Testing its performance and accuracy with LM Studio."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://exitcode0.net/posts/"},{"@type":"ListItem","position":2,"name":"Testing Llama3 With LM Studio","item":"https://exitcode0.net/posts/testing-llama3-with-lmstudio/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Testing Llama3 With LM Studio","name":"Testing Llama3 With LM Studio","description":"Taking a look at the the latest open source llama 3 model after its April 2024 release. Testing its performance and accuracy with LM Studio.","keywords":["stable-diffusion","AI","art"],"articleBody":"MetaAI have just introduced Llama 3 to the world and the open source community is already putting it through its paces and pushing to find the limits of what it can produce. One fantastic tool which has made self hosted LLMs that rival paid services like ChatGPT and Claude possible is LM Studio. With version 0.2.20 they bough about support for llama 3 along with a GGUF quantized 8 billion parameter version of the model.\nInstalling the model The beautiful thing about LM studio is how simple it is to get up and running. This project has made brilliant progress towards bringing local LLMs to the world. I feel that it is of upmost importance that projects like LM studio and Jan continue to grow and prevent services like OpenAI’s ChatGPT from building a paywall around the technological revolution that is large language models. There will always be a place for paid version of this technology, but it cannot exists as the only available option.\nInstalling the new llama3 model is just as simple as ever in LM Studio. Once you have updated to version 0.2.20, you will see the lmstudio-community model on the home page. However, clicking download from here, might not given you the highest quantized version that your system is capable of running. Instead click the search icon and you will be directed to a page which lists all available version of that model.\nInstall llama3 model in LM Studio: Finding the model\nNow you can selected the version that best suits your needs or system profile. I have a GPU with 12GB VRAM and can therefore enable full GPU offload for the Meta-Llama-3-8B-Instruct-Q8_0.gguf (8.54 GB) version of the model. Hit download on the model version you want to grab.\nInstall llama3 model in LM Studio: Installing the best model\nNow head over to the chat tab (on the left) and select the llama 3 model. At this point you might be prompted to accept a new prompt or keep your existing prompt. You want to accept the new prompt.\nInstall llama3 model in LM Studio: Loading the model\nDefault llama3 prompt Our default llama3 prompt in LM Studio looks like this:\n{ \"name\": \"Llama 3\", \"inference_params\": { \"input_prefix\": \"\u003c|start_header_id|\u003euser\u003c|end_header_id|\u003e\\n\\n\", \"input_suffix\": \"\u003c|eot_id|\u003e\u003c|start_header_id|\u003eassistant\u003c|end_header_id|\u003e\\n\\n\", \"pre_prompt\": \"You are a helpful, smart, kind, and efficient AI assistant. You always fulfill the user's requests to the best of your ability.\", \"pre_prompt_prefix\": \"\u003c|start_header_id|\u003esystem\u003c|end_header_id|\u003e\\n\\n\", \"pre_prompt_suffix\": \"\u003c|eot_id|\u003e\", \"antiprompt\": [\"\u003c|start_header_id|\u003e\", \"\u003c|eot_id|\u003e\"] } } I chose to set full GPU utilisation, keep the entire model in RAM and bumped the context length all the way up to the support maximum: 8192.\nPrompt configuration for llama3 model in LM Studio\nAs I will discus in the upcoming performance section, I did hit the context limit, which ultimately lead to some less satisfactory output.\nPerformance Let me start by providing some system specs as context. I have by 2024 standards, a modest desktop computer:\nRyzen 5600 6c/12t CPU 32GB 3200MHz DDR4 RAM Nvidia RTX 3060 12GB GDDR6 GPU It would be great to test these models on bleeding edge hardware, enterprise hardware and even Apple M3 silicon, but hardware isn’t cheap these days and I, like many, don’t have the resources to acquire it. Thankfully it seems that llama3 performance at this hardware level is very good and there’s minimal, perceivable slowdown as the context token count increases. I was experiencing speeds of 23 tokens per second in LM Studio and my chat focusing on writing a python script was remarkable.\nPerformance of llama3 model in LM Studio\nResults Ok so, what did I ask llama3? This version of the model is fine tuned for instructional tasks, so for now, I asked for help improving a basic python script. This is a great way to test how current and accurate a model is. Here is my full transcript…\nGood morning, I have the following python code that I want to improve:\nimport requests url = \"https://demo.rading212.com/api/v0/equity/pies\" headers = {\"Authorization\": \"SOMERANDOMAPIKEY\"} response = requests.get(url, headers=headers) print(response.status_code) if response.status_code == 200: data = response.json() if data: print(data) else: print(response.status_code) I want to implement functions and threading so that I can run this code in a docker container. I want to pass important variables like the time between requests and the Authorization key. I also want to introduce a function which sends the data returned by the successful request to a postgres database. Here is what typical json response looks like:\n[{'id': 696969, 'cash': 0.48, 'dividendDetails': {'gained': 7.94, 'reinvested': 7.41, 'inCash': 0.46}, 'result': {'investedValue': 302.4, 'value': 318.35, 'result': 15.95, 'resultCoef': 0.0527}, 'progress': 0.3986, 'status': None}, {'id': 696968, 'cash': 0.12, 'dividendDetails': {'gained': 0.72, 'reinvested': 0.63, 'inCash': 0.09}, 'result': {'investedValue': 300.14, 'value': 404.68, 'result': 104.54, 'resultCoef': 0.3483}, 'progress': 0.0792, 'status': None}, {'id': 696867, 'cash': 0.55, 'dividendDetails': {'gained': 0.55, 'reinvested': 0.0, 'inCash': 0.55}, 'result': {'investedValue': 249.27, 'value': 278.99, 'result': 29.72, 'resultCoef': 0.1192}, 'progress': None, 'status': None}, {'id': 696868, 'cash': 0.0, 'dividendDetails': {'gained': 0.0, 'reinvested': 0.0, 'inCash': 0.0}, 'result': {'investedValue': 0, 'value': 0.0, 'result': 0.0, 'resultCoef': 0}, 'progress': None, 'status': None}, {'id': 2181613, 'cash': 0.0, 'dividendDetails': {'gained': 0.0, 'reinvested': 0.0, 'inCash': 0.0}, 'result': {'investedValue': 0, 'value': 0, 'result': 0, 'resultCoef': 0}, 'progress': None, 'status': None}]\nI’d be happy to help you improve your code. Here is a refactored version of your code using functions and threading:\nimport requests import threading import time import psycopg2 # Configuration variables TIME_BETWEEN_REQUESTS = 5 # in seconds AUTHORIZATION_KEY = \"SOMERANDOMAPIKEY\" class Trading212API: def __init__(self, authorization_key): self.authorization_key = authorization_key def get_pies(self): url = \"https://demo.rading212.com/api/v0/equity/pies\" headers = {\"Authorization\": self.authorization_key} response = requests.get(url, headers=headers) return response.json() class DatabaseWriter: def __init__(self, database_url, table_name): self.database_url = database_url self.table_name = table_name def write_data_to_db(self, data): conn = psycopg2.connect(self.database_url) cur = conn.cursor() for item in data: cur.execute(\"INSERT INTO {} (id, cash, dividend_details, result, progress, status)\".format(self.table_name), (item['id'], item['cash'], item['dividendDetails'], item['result'], item['progress'], item['status'])) conn.commit() conn.close() def send_request_and_write_to_db(api, db_writer): while True: data = api.get_pies() if data: db_writer.write_data_to_db(data) time.sleep(TIME_BETWEEN_REQUESTS) if __name__ == \"__main__\": api = Trading212API(AUTHORIZATION_KEY) db_writer = DatabaseWriter(\"host=localhost port=5432 dbname=mydatabase user=myuser password=mypassword\", \"mytable\") thread = threading.Thread(target=send_request_and_write_to_db, args=(api, db_writer)) thread.start() Here’s what I did:\nExtracted the API key and other configuration variables to separate constants. Created a Trading212API class that encapsulates the API request logic. Created a DatabaseWriter class that encapsulates the database writing logic. Introduced a send_request_and_write_to_db function that sends an API request and writes the response to the database. This function is run in a separate thread using threading. In the main code, I create instances of the Trading212API and DatabaseWriter classes and start the thread. Note: You’ll need to install the psycopg2 library to use this code with PostgreSQL. Also, make sure to replace the database URL and table name in the DatabaseWriter constructor with your actual values.\nAlso, you may want to consider handling errors and exceptions more robustly in the code. This is just a starting point, and you may need to add additional error handling depending on your specific requirements.\nAs this will be running in a container, TIME_BETWEEN_REQUESTS and AUTHORIZATION_KEY will be environment variables, can you adjust the code to load them from env?\nYes, I can help with that! Here’s an updated version of the code that loads the TIME_BETWEEN_REQUESTS and AUTHORIZATION_KEY from environment variables:\nimport requests import threading import time import psycopg2 from os import getenv # Configuration variables TIME_BETWEEN_REQUESTS = int(getenv(\"TIME_BETWEEN_REQUESTS\", 5)) # in seconds AUTHORIZATION_KEY = getenv(\"AUTHORIZATION_KEY\") class Trading212API: def __init__(self, authorization_key): self.authorization_key = authorization_key def get_pies(self): url = \"https://demo.rading212.com/api/v0/equity/pies\" headers = {\"Authorization\": self.authorization_key} response = requests.get(url, headers=headers) return response.json() class DatabaseWriter: def __init__(self, database_url, table_name): self.database_url = database_url self.table_name = table_name def write_data_to_db(self, data): conn = psycopg2.connect(self.database_url) cur = conn.cursor() for item in data: cur.execute(\"INSERT INTO {} (id, cash, dividend_details, result, progress, status)\".format(self.table_name), (item['id'], item['cash'], str(item['dividendDetails']), str(item['result']), item['progress'], item['status'])) conn.commit() conn.close() def send_request_and_write_to_db(api, db_writer): while True: data = api.get_pies() if data: db_writer.write_data_to_db(data) time.sleep(TIME_BETWEEN_REQUESTS) if __name__ == \"__main__\": api = Trading212API(AUTHORIZATION_KEY) db_writer = DatabaseWriter(getenv(\"DATABASE_URL\"), getenv(\"TABLE_NAME\")) thread = threading.Thread(target=send_request_and_write_to_db, args=(api, db_writer)) thread.start() In this code:\nWe’ve used the getenv function from Python’s os module to load the environment variables TIME_BETWEEN_REQUESTS and AUTHORIZATION_KEY. The default value for TIME_BETWEEN_REQUESTS is 5 seconds if it’s not provided. For loading database URL and table name, we’re using getenv function in the same way as above. Make sure to set these environment variables in your Docker container before running this script. By doing so, you can easily manage these settings from your environment or configuration files without having to modify the code itself.\nI will be using postgres as a source for grafana, please can you include the current time in the postgres INSERT command?\nHere’s an updated version of the write_data_to_db method that includes the current timestamp in the INSERT command:\nclass DatabaseWriter: def __init__(self, database_url, table_name): self.database_url = database_url self.table_name = table_name def write_data_to_db(self, data): conn = psycopg2.connect(self.database_url) cur = conn.cursor() for item in data: now = time.strftime('%Y-%m-%d %H:%M:%S') # Get current timestamp cur.execute(\"\"\" INSERT INTO {} (id, cash, dividend_details, result, progress, status, inserted_at) VALUES (%s, %s, %s, %s, %s, %s, %s) \"\"\".format(self.table_name), (item['id'], item['cash'], str(item['dividendDetails']), str(item['result']), item['progress'], item['status'], now)) conn.commit() conn.close() Can you please give me the full script with all current modifications?\nHere is the full script with all the modifications we’ve made:\nimport requests import threading import time import psycopg2 from os import getenv, environ import datetime environ['TZ'] = 'UTC' # Set timezone to UTC for timestamp conversion time.tzset() # Configuration variables TIME_BETWEEN_REQUESTS = int(getenv(\"TIME_BETWEEN_REQUESTS\", 5)) # in seconds AUTHORIZATION_KEY = getenv(\"AUTHORIZATION_KEY\") DATABASE_URL = getenv(\"DATABASE_URL\") TABLE_NAME = getenv(\"TABLE_NAME\") class Trading212API: def __init__(self, authorization_key): self.authorization_key = authorization_key def get_pies(self): url = \"https://demo.rading212.com/api/v0/equity/pies\" headers = {\"Authorization\": self.authorization_key} response = requests.get(url, headers=headers) return response.json() class DatabaseWriter: def __init__(self, database_url, table_name): self.database_url = database_url self.table_name = table_name def write_data_to_db(self, data): conn = psycopg2.connect(self.database_url) cur = conn.cursor() for item in data: now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S') # Get current timestamp cur.execute(\"\"\" INSERT INTO {} (id, cash, dividend_details, result, progress, status, inserted_at) VALUES (%s, %s, %s, %s, %s, %s, %s) \"\"\".format(self.table_name), (item['id'], item['cash'], str(item[ 'dividendDetails']), str(item['result']), item['progress'], item['status'], now)) conn.commit() conn.close() def send_request_and_write_to_db(api, db_writer): while True: data = api.get_pies() if data: db_writer.write_data_to_db(data) time.sleep(TIME_BETWEEN_REQUESTS) if __name__ == \"__main__\": api = Trading212API(AUTHORIZATION_KEY) db_writer = DatabaseWriter(DATABASE_URL, TABLE_NAME) thread = threading.Thread(target=send_request_and_write_to_db, args=(api, db_writer)) thread.start() This script should now work as expected. It loads the configuration variables from environment variables, makes API requests to the Trading212 API, writes the results to a PostgreSQL database with the current timestamp, and runs in an infinite loop with the specified interval between requests.\nI am getting this error because I am developing on windows: AttributeError: module 'time' has no attribute 'tzset'. Is there an alternative way to do this?\nYes, you’re correct that time.tzset() is not available in Windows. The tzset function is a Unix-specific function that sets the timezone environment variable.\nTo set the timezone on Windows, you can use the os.environ['TZ'] = 'UTC' line before calling time.tzset(). However, since time.tzset() is not available in Windows, this line will have no effect.\nSo, if you’re developing on Windows, you can simply remove the lines that set the timezone and use the datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S') to get the current timestamp. This will give you the local system time without considering any timezone settings.\nHere is the modified code:\nimport requests import threading import time import datetime import psycopg2 from os import getenv, environ # Configuration variables TIME_BETWEEN_REQUESTS = int(getenv(\"TIME_BETWEEN_REQUESTS\", 5)) # in seconds AUTHORIZATION_KEY = getenv(\"AUTHORIZATION_KEY\") DATABASE_URL = getenv(\"DATABASE_URL\") TABLE_NAME = getenv(\"TABLE_NAME\") class Trading212API: def __init__(self, authorization_key): self.authorization_key = authorization_key def get_pies(self): url = \"https://demo.rading212.com/api/v0/equity/pies\" headers = {\"Authorization\": self.authorization_key} response = requests.get(url, headers=headers) return response.json() class DatabaseWriter: def __init__(self, database_url, table_name): self.database_url = database_url self.table_name = table_name def write_data_to_db(self, data): conn = psycopg2.connect(self(database_url)) cur = conn.cursor() for item in data: now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S') # Get current timestamp cur.execute(\"\"\" INSERT INTO {} (id, cash, dividend_details, result, progress, status, inserted_at) VALUES (%s, %s, %s, %s, %s, %s, %s) \"\"\" .format(self.table_name), (item['id'], item['cash'], str(item[ 'dividendDetails']), str(item[ 'result']), item['progress'], item['status'], now)) conn.commit() conn.close() def send_request_and_write_to_db(api, db_writer): while True: data = api.get_pies() if data: db_writer.write_data_to_db(data) time.sleep(TIME_BETWEEN_REQUESTS) if __name__ == \"__main__\": api = Trading212API(AUTHORIZATION_KEY) db_writer = DatabaseWriter(DATABASE_URL, TABLE_NAME) thread = threading.Thread(target=send_request_and_write_to_db, args=(api, db_writer)) thread.start() This code should work as expected on both Unix and Windows.\nOne last task, can you help me write a docker compose file which will create a container to run our python code, a container for postgres (where our python script will insert to) including an init script to make the table, and a grafana instance? Can you include any environment variables which we will need to pass to our python script such as database_url and table_name\nHere is a Docker Compose file that creates three containers: one for your Python script, one for PostgreSQL with an initial script to create the table, and one for Grafana:\nversion: \"3\" services: db: image: postgres restart: always environment: POSTGRES_USER: myuser POSTGRES_PASSWORD: mypassword POSTGRES_DB: mydatabase volumes: - db-data:/var/lib/postgresql/data init-db: build: ./init-db depends_on: - db command: python init.py python-app: build: . depends_on: - db environment: DATABASE_URL: \"postgresql://myuser:mypassword@db:5432/mydatabase\" TABLE_NAME: \"mytable\" TIME_BETWEEN_REQUESTS: 5 AUTHORIZATION_KEY: \"your-authorization-key\" command: python app.py grafana: image: grafana/grafana restart: always ports: - \"3000:3000\" volumes: db-data: Here’s what this file does:\nIt creates a db service that runs the official PostgreSQL image, sets environment variables for the user, password, and database name, and mounts a volume to persist data. It creates an init-db service that builds from a directory named init-db in the current directory, depends on the db service, and runs a command to create the table using a Python script named init.py. It creates a python-app service that builds from the current directory, depends on the db service, sets environment variables for the database URL, table name, time between requests, and authorization key, and runs the command to start the Python app. It creates a grafana service that runs the official Grafana image, exposes port 3000, and restarts always. To use this file, create a directory named init-db in the same directory as your Docker Compose file, and add an init.py script to it with the following contents:\nimport psycopg2 conn = psycopg2.connect( host=\"localhost\", database=\"mydatabase\", user=\"myuser\", password=\"mypassword\" ) cur = conn.cursor() cur.execute(\"\"\" CREATE TABLE IF NOT EXISTS mytable ( id SERIAL PRIMARY KEY, cash REAL, dividend_details TEXT, result REAL, progress REAL, status TEXT, inserted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ); \"\"\") conn.commit() This script connects to the PostgreSQL database, creates a table named mytable with the specified columns if it doesn’t exist, and commits the changes.\nThen, you can run docker-compose up -d in your terminal to start all services in detached mode.\nConclusion The responses are very fast and accurate, the model takes care to consider all aspects of the prompt and for the most part holds onto the context of the conversation. When I pivoted towards asking about Docker configurations, things started to fall apart and mistakes were introduced. For example our postgres init script was never going to run without a Dockerfile and the practice of splitting this out into a stand alone services makes the deployment less idempotent. The robots won’t be taking out jobs just yet…\nThey didn’t take our jerbs… yet\nUltimately, I reach the token count and the responses started to drop previously fixed sections of code. This is a common issue with all LLM services and one that Clause 3 looks to solve with enormous context token values… unfortunately this could get very expensive due to the token based pricing structure.\nThe people of the LM Studio discord server are begging for RAG type document referencing features, which would be great. But, relatively small context token counts will mean that this feature could quickly lead to model confusion.\nTLDR Llama3 is another step in the right direction and LM Studio once again proves to be an exceptional demonstration of free open source software, but there is always more work to be done\n","wordCount":"2617","inLanguage":"en","datePublished":"2024-04-19T07:00:00+01:00","dateModified":"2024-04-19T07:00:00+01:00","author":{"@type":"Person","name":"Tom"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://exitcode0.net/posts/testing-llama3-with-lmstudio/"},"publisher":{"@type":"Organization","name":"ExitCode0","logo":{"@type":"ImageObject","url":"https://exitcode0.net/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://exitcode0.net/ accesskey=h title="ExitCode0 (Alt + H)">ExitCode0</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://datasolace.com/ title=DataSolace><span>DataSolace</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://exitcode0.net/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://exitcode0.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://exitcode0.net/privacy/ title=Privacy><span>Privacy</span></a></li><li><a href=https://exitcode0.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://exitcode0.net/>Home</a>&nbsp;»&nbsp;<a href=https://exitcode0.net/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Testing Llama3 With LM Studio</h1><div class=post-description>Taking a look at the the latest open source llama 3 model after its April 2024 release. Testing its performance and accuracy with LM Studio.</div><div class=post-meta><span title='2024-04-19 07:00:00 +0100 +0100'>April 19, 2024</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Tom</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#installing-the-model aria-label="Installing the model">Installing the model</a></li><li><a href=#default-llama3-prompt aria-label="Default llama3 prompt">Default llama3 prompt</a></li><li><a href=#performance aria-label=Performance>Performance</a></li><li><a href=#results aria-label=Results>Results</a></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a><ul><li><a href=#tldr aria-label=TLDR>TLDR</a></li></ul></li></ul></div></details></div><div class=post-content><p>MetaAI have <a href=https://about.fb.com/news/2024/04/meta-ai-assistant-built-with-llama-3/>just introduced</a> Llama 3 to the world and the open source community is already putting it through its paces and pushing to find the limits of what it can produce. One fantastic tool which has made self hosted LLMs that rival paid services like <a href=https://chat.openai.com/>ChatGPT</a> and <a href=https://claude.ai/>Claude</a> possible is <a href=https://lmstudio.ai/>LM Studio</a>. With version 0.2.20 they bough about support for llama 3 along with a <a href=https://huggingface.co/lmstudio-community/Meta-Llama-3-8B-Instruct-GGUF>GGUF quantized 8 billion parameter</a> version of the model.</p><h2 id=installing-the-model>Installing the model<a hidden class=anchor aria-hidden=true href=#installing-the-model>#</a></h2><p>The beautiful thing about LM studio is how simple it is to get up and running. This project has made brilliant progress towards bringing local LLMs to the world. I feel that it is of upmost importance that projects like LM studio and Jan continue to grow and prevent services like OpenAI&rsquo;s ChatGPT from building a paywall around the technological revolution that is large language models. There will always be a place for paid version of this technology, but it cannot exists as the only available option.</p><p>Installing the new llama3 model is just as simple as ever in LM Studio. Once you have updated to version 0.2.20, you will see the lmstudio-community model on the home page. However, clicking download from here, might not given you the highest quantized version that your system is capable of running. Instead click the search icon and you will be directed to a page which lists all available version of that model.</p><figure><img loading=lazy src=/images/llama3-lmstudio-install-01.png alt="Install llama3 model in LM Studio: Finding the model"><figcaption><p>Install llama3 model in LM Studio: Finding the model</p></figcaption></figure><p>Now you can selected the version that best suits your needs or system profile. I have a GPU with 12GB VRAM and can therefore enable full GPU offload for the Meta-Llama-3-8B-Instruct-Q8_0.gguf (8.54 GB) version of the model. Hit download on the model version you want to grab.</p><figure><img loading=lazy src=/images/llama3-lmstudio-install-02.png alt="Install llama3 model in LM Studio: Installing the best model"><figcaption><p>Install llama3 model in LM Studio: Installing the best model</p></figcaption></figure><p>Now head over to the chat tab (on the left) and select the llama 3 model. At this point you might be prompted to accept a new prompt or keep your existing prompt. You want to accept the new prompt.</p><figure><img loading=lazy src=/images/llama3-lmstudio-install-03.png alt="Install llama3 model in LM Studio: Loading the model"><figcaption><p>Install llama3 model in LM Studio: Loading the model</p></figcaption></figure><h2 id=default-llama3-prompt>Default llama3 prompt<a hidden class=anchor aria-hidden=true href=#default-llama3-prompt>#</a></h2><p>Our default llama3 prompt in LM Studio looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;Llama 3&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;inference_params&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;input_prefix&#34;</span>: <span style=color:#e6db74>&#34;&lt;|start_header_id|&gt;user&lt;|end_header_id|&gt;\n\n&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;input_suffix&#34;</span>: <span style=color:#e6db74>&#34;&lt;|eot_id|&gt;&lt;|start_header_id|&gt;assistant&lt;|end_header_id|&gt;\n\n&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pre_prompt&#34;</span>: <span style=color:#e6db74>&#34;You are a helpful, smart, kind, and efficient AI assistant. You always fulfill the user&#39;s requests to the best of your ability.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pre_prompt_prefix&#34;</span>: <span style=color:#e6db74>&#34;&lt;|start_header_id|&gt;system&lt;|end_header_id|&gt;\n\n&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;pre_prompt_suffix&#34;</span>: <span style=color:#e6db74>&#34;&lt;|eot_id|&gt;&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;antiprompt&#34;</span>: [<span style=color:#e6db74>&#34;&lt;|start_header_id|&gt;&#34;</span>, <span style=color:#e6db74>&#34;&lt;|eot_id|&gt;&#34;</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I chose to set full GPU utilisation, keep the entire model in RAM and bumped the context length all the way up to the support maximum: 8192.</p><figure><img loading=lazy src=/images/llama3-lmstudio-prompt.png alt="Prompt configuration for llama3 model in LM Studio"><figcaption><p>Prompt configuration for llama3 model in LM Studio</p></figcaption></figure><p>As I will discus in the upcoming performance section, I did hit the context limit, which ultimately lead to some less satisfactory output.</p><h2 id=performance>Performance<a hidden class=anchor aria-hidden=true href=#performance>#</a></h2><p>Let me start by providing some system specs as context. I have by 2024 standards, a modest desktop computer:</p><ul><li>Ryzen 5600 6c/12t CPU</li><li>32GB 3200MHz DDR4 RAM</li><li>Nvidia RTX 3060 12GB GDDR6 GPU</li></ul><p>It would be great to test these models on bleeding edge hardware, enterprise hardware and even Apple M3 silicon, but hardware isn&rsquo;t cheap these days and I, like many, don&rsquo;t have the resources to acquire it. Thankfully it seems that llama3 performance at this hardware level is very good and there&rsquo;s minimal, perceivable slowdown as the context token count increases. I was experiencing speeds of 23 tokens per second in LM Studio and my chat focusing on writing a python script was remarkable.</p><figure><img loading=lazy src=/images/llama3-lmstudio-performance.png alt="Performance of llama3 model in LM Studio"><figcaption><p>Performance of llama3 model in LM Studio</p></figcaption></figure><h2 id=results>Results<a hidden class=anchor aria-hidden=true href=#results>#</a></h2><p>Ok so, what did I <em>ask</em> llama3? This version of the model is fine tuned for instructional tasks, so for now, I asked for help improving a basic python script. This is a great way to test how current and accurate a model is. Here is my full transcript&mldr;</p><p><strong>Good morning, I have the following python code that I want to improve:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://demo.rading212.com/api/v0/equity/pies&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: <span style=color:#e6db74>&#34;SOMERANDOMAPIKEY&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>print(response<span style=color:#f92672>.</span>status_code)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> response<span style=color:#f92672>.</span>status_code <span style=color:#f92672>==</span> <span style=color:#ae81ff>200</span>:
</span></span><span style=display:flex><span>data <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> data:
</span></span><span style=display:flex><span>print(data)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>print(response<span style=color:#f92672>.</span>status_code)
</span></span></code></pre></div><p><strong>I want to implement functions and threading so that I can run this code in a docker container. I want to pass important variables like the time between requests and the Authorization key. I also want to introduce a function which sends the data returned by the successful request to a postgres database. Here is what typical json response looks like:</strong></p><p><code>[{'id': 696969, 'cash': 0.48, 'dividendDetails': {'gained': 7.94, 'reinvested': 7.41, 'inCash': 0.46}, 'result': {'investedValue': 302.4, 'value': 318.35, 'result': 15.95, 'resultCoef': 0.0527}, 'progress': 0.3986, 'status': None}, {'id': 696968, 'cash': 0.12, 'dividendDetails': {'gained': 0.72, 'reinvested': 0.63, 'inCash': 0.09}, 'result': {'investedValue': 300.14, 'value': 404.68, 'result': 104.54, 'resultCoef': 0.3483}, 'progress': 0.0792, 'status': None}, {'id': 696867, 'cash': 0.55, 'dividendDetails': {'gained': 0.55, 'reinvested': 0.0, 'inCash': 0.55}, 'result': {'investedValue': 249.27, 'value': 278.99, 'result': 29.72, 'resultCoef': 0.1192}, 'progress': None, 'status': None}, {'id': 696868, 'cash': 0.0, 'dividendDetails': {'gained': 0.0, 'reinvested': 0.0, 'inCash': 0.0}, 'result': {'investedValue': 0, 'value': 0.0, 'result': 0.0, 'resultCoef': 0}, 'progress': None, 'status': None}, {'id': 2181613, 'cash': 0.0, 'dividendDetails': {'gained': 0.0, 'reinvested': 0.0, 'inCash': 0.0}, 'result': {'investedValue': 0, 'value': 0, 'result': 0, 'resultCoef': 0}, 'progress': None, 'status': None}]</code></p><hr><p>I&rsquo;d be happy to help you improve your code. Here is a refactored version of your code using functions and threading:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configuration variables</span>
</span></span><span style=display:flex><span>TIME_BETWEEN_REQUESTS <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>  <span style=color:#75715e># in seconds</span>
</span></span><span style=display:flex><span>AUTHORIZATION_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;SOMERANDOMAPIKEY&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Trading212API</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, authorization_key):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>authorization_key <span style=color:#f92672>=</span> authorization_key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_pies</span>(self):
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://demo.rading212.com/api/v0/equity/pies&#34;</span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: self<span style=color:#f92672>.</span>authorization_key}
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseWriter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, database_url, table_name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>database_url <span style=color:#f92672>=</span> database_url
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>table_name <span style=color:#f92672>=</span> table_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_data_to_db</span>(self, data):
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>database_url)
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> data:
</span></span><span style=display:flex><span>            cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;INSERT INTO </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> (id, cash, dividend_details, result, progress, status)&#34;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>table_name),
</span></span><span style=display:flex><span>                        (item[<span style=color:#e6db74>&#39;id&#39;</span>], item[<span style=color:#e6db74>&#39;cash&#39;</span>], item[<span style=color:#e6db74>&#39;dividendDetails&#39;</span>], item[<span style=color:#e6db74>&#39;result&#39;</span>], item[<span style=color:#e6db74>&#39;progress&#39;</span>], item[<span style=color:#e6db74>&#39;status&#39;</span>]))
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_request_and_write_to_db</span>(api, db_writer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span>get_pies()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data:
</span></span><span style=display:flex><span>            db_writer<span style=color:#f92672>.</span>write_data_to_db(data)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(TIME_BETWEEN_REQUESTS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    api <span style=color:#f92672>=</span> Trading212API(AUTHORIZATION_KEY)
</span></span><span style=display:flex><span>    db_writer <span style=color:#f92672>=</span> DatabaseWriter(<span style=color:#e6db74>&#34;host=localhost port=5432 dbname=mydatabase user=myuser password=mypassword&#34;</span>, <span style=color:#e6db74>&#34;mytable&#34;</span>)
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>send_request_and_write_to_db, args<span style=color:#f92672>=</span>(api, db_writer))
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>Here&rsquo;s what I did:</p><ol><li>Extracted the API key and other configuration variables to separate constants.</li><li>Created a <code>Trading212API</code> class that encapsulates the API request logic.</li><li>Created a <code>DatabaseWriter</code> class that encapsulates the database writing logic.</li><li>Introduced a <code>send_request_and_write_to_db</code> function that sends an API request and writes the response to the database. This function is run in a separate thread using <code>threading</code>.</li><li>In the main code, I create instances of the <code>Trading212API</code> and <code>DatabaseWriter</code> classes and start the thread.</li></ol><p>Note: You&rsquo;ll need to install the <code>psycopg2</code> library to use this code with PostgreSQL. Also, make sure to replace the database URL and table name in the <code>DatabaseWriter</code> constructor with your actual values.</p><p>Also, you may want to consider handling errors and exceptions more robustly in the code. This is just a starting point, and you may need to add additional error handling depending on your specific requirements.</p><hr><p><strong>As this will be running in a container, TIME_BETWEEN_REQUESTS and AUTHORIZATION_KEY will be environment variables, can you adjust the code to load them from env?</strong></p><hr><p>Yes, I can help with that! Here&rsquo;s an updated version of the code that loads the <code>TIME_BETWEEN_REQUESTS</code> and <code>AUTHORIZATION_KEY</code> from environment variables:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os <span style=color:#f92672>import</span> getenv
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configuration variables</span>
</span></span><span style=display:flex><span>TIME_BETWEEN_REQUESTS <span style=color:#f92672>=</span> int(getenv(<span style=color:#e6db74>&#34;TIME_BETWEEN_REQUESTS&#34;</span>, <span style=color:#ae81ff>5</span>))  <span style=color:#75715e># in seconds</span>
</span></span><span style=display:flex><span>AUTHORIZATION_KEY <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;AUTHORIZATION_KEY&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Trading212API</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, authorization_key):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>authorization_key <span style=color:#f92672>=</span> authorization_key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_pies</span>(self):
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://demo.rading212.com/api/v0/equity/pies&#34;</span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: self<span style=color:#f92672>.</span>authorization_key}
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseWriter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, database_url, table_name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>database_url <span style=color:#f92672>=</span> database_url
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>table_name <span style=color:#f92672>=</span> table_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_data_to_db</span>(self, data):
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>database_url)
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> data:
</span></span><span style=display:flex><span>            cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;INSERT INTO </span><span style=color:#e6db74>{}</span><span style=color:#e6db74> (id, cash, dividend_details, result, progress, status)&#34;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>table_name),
</span></span><span style=display:flex><span>                         (item[<span style=color:#e6db74>&#39;id&#39;</span>], item[<span style=color:#e6db74>&#39;cash&#39;</span>], str(item[<span style=color:#e6db74>&#39;dividendDetails&#39;</span>]), str(item[<span style=color:#e6db74>&#39;result&#39;</span>]), item[<span style=color:#e6db74>&#39;progress&#39;</span>], item[<span style=color:#e6db74>&#39;status&#39;</span>]))
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_request_and_write_to_db</span>(api, db_writer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span>get_pies()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data:
</span></span><span style=display:flex><span>            db_writer<span style=color:#f92672>.</span>write_data_to_db(data)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(TIME_BETWEEN_REQUESTS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    api <span style=color:#f92672>=</span> Trading212API(AUTHORIZATION_KEY)
</span></span><span style=display:flex><span>    db_writer <span style=color:#f92672>=</span> DatabaseWriter(getenv(<span style=color:#e6db74>&#34;DATABASE_URL&#34;</span>), getenv(<span style=color:#e6db74>&#34;TABLE_NAME&#34;</span>))
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>send_request_and_write_to_db, args<span style=color:#f92672>=</span>(api, db_writer))
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>In this code:</p><ul><li>We&rsquo;ve used the <code>getenv</code> function from Python&rsquo;s <code>os</code> module to load the environment variables <code>TIME_BETWEEN_REQUESTS</code> and <code>AUTHORIZATION_KEY</code>. The default value for <code>TIME_BETWEEN_REQUESTS</code> is 5 seconds if it&rsquo;s not provided.</li><li>For loading database URL and table name, we&rsquo;re using <code>getenv</code> function in the same way as above. Make sure to set these environment variables in your Docker container before running this script.</li></ul><p>By doing so, you can easily manage these settings from your environment or configuration files without having to modify the code itself.</p><hr><p><strong>I will be using postgres as a source for grafana, please can you include the current time in the postgres INSERT command?</strong></p><hr><p>Here&rsquo;s an updated version of the <code>write_data_to_db</code> method that includes the current timestamp in the INSERT command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseWriter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, database_url, table_name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>database_url <span style=color:#f92672>=</span> database_url
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>table_name <span style=color:#f92672>=</span> table_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_data_to_db</span>(self, data):
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>database_url)
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> data:
</span></span><span style=display:flex><span>            now <span style=color:#f92672>=</span> time<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M:%S&#39;</span>)  <span style=color:#75715e># Get current timestamp</span>
</span></span><span style=display:flex><span>            cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                INSERT INTO </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                (id, cash, dividend_details, result, progress, status, inserted_at)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;&#34;&#34;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>table_name),
</span></span><span style=display:flex><span>                         (item[<span style=color:#e6db74>&#39;id&#39;</span>], item[<span style=color:#e6db74>&#39;cash&#39;</span>], str(item[<span style=color:#e6db74>&#39;dividendDetails&#39;</span>]), str(item[<span style=color:#e6db74>&#39;result&#39;</span>]), item[<span style=color:#e6db74>&#39;progress&#39;</span>], item[<span style=color:#e6db74>&#39;status&#39;</span>], now))
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span></code></pre></div><hr><p><strong>Can you please give me the full script with all current modifications?</strong></p><hr><p>Here is the full script with all the modifications we&rsquo;ve made:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os <span style=color:#f92672>import</span> getenv, environ
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span>environ[<span style=color:#e6db74>&#39;TZ&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;UTC&#39;</span>  <span style=color:#75715e># Set timezone to UTC for timestamp conversion</span>
</span></span><span style=display:flex><span>time<span style=color:#f92672>.</span>tzset()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configuration variables</span>
</span></span><span style=display:flex><span>TIME_BETWEEN_REQUESTS <span style=color:#f92672>=</span> int(getenv(<span style=color:#e6db74>&#34;TIME_BETWEEN_REQUESTS&#34;</span>, <span style=color:#ae81ff>5</span>))  <span style=color:#75715e># in seconds</span>
</span></span><span style=display:flex><span>AUTHORIZATION_KEY <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;AUTHORIZATION_KEY&#34;</span>)
</span></span><span style=display:flex><span>DATABASE_URL <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;DATABASE_URL&#34;</span>)
</span></span><span style=display:flex><span>TABLE_NAME <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;TABLE_NAME&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Trading212API</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, authorization_key):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>authorization_key <span style=color:#f92672>=</span> authorization_key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_pies</span>(self):
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://demo.rading212.com/api/v0/equity/pies&#34;</span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: self<span style=color:#f92672>.</span>authorization_key}
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseWriter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, database_url, table_name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>database_url <span style=color:#f92672>=</span> database_url
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>table_name <span style=color:#f92672>=</span> table_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_data_to_db</span>(self, data):
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(self<span style=color:#f92672>.</span>database_url)
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> data:
</span></span><span style=display:flex><span>            now <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M:%S&#39;</span>)  <span style=color:#75715e># Get current timestamp</span>
</span></span><span style=display:flex><span>            cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                INSERT INTO </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 (id, cash, dividend_details, result, progress, status, inserted_at)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             &#34;&#34;&#34;</span><span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>table_name),
</span></span><span style=display:flex><span>                         (item[<span style=color:#e6db74>&#39;id&#39;</span>], item[<span style=color:#e6db74>&#39;cash&#39;</span>], str(item[ <span style=color:#e6db74>&#39;dividendDetails&#39;</span>]), str(item[<span style=color:#e6db74>&#39;result&#39;</span>]), item[<span style=color:#e6db74>&#39;progress&#39;</span>], item[<span style=color:#e6db74>&#39;status&#39;</span>], now))
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_request_and_write_to_db</span>(api, db_writer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span>get_pies()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data:
</span></span><span style=display:flex><span>            db_writer<span style=color:#f92672>.</span>write_data_to_db(data)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(TIME_BETWEEN_REQUESTS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    api <span style=color:#f92672>=</span> Trading212API(AUTHORIZATION_KEY)
</span></span><span style=display:flex><span>    db_writer <span style=color:#f92672>=</span> DatabaseWriter(DATABASE_URL, TABLE_NAME)
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>send_request_and_write_to_db, args<span style=color:#f92672>=</span>(api, db_writer))
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>This script should now work as expected. It loads the configuration variables from environment variables, makes API requests to the Trading212 API, writes the results to a PostgreSQL database with the current timestamp, and runs in an infinite loop with the specified interval between requests.</p><hr><p><strong>I am getting this error because I am developing on windows:
<code>AttributeError: module 'time' has no attribute 'tzset'</code>.
Is there an alternative way to do this?</strong></p><hr><p>Yes, you&rsquo;re correct that <code>time.tzset()</code> is not available in Windows. The <code>tzset</code> function is a Unix-specific function that sets the timezone environment variable.</p><p>To set the timezone on Windows, you can use the <code>os.environ['TZ'] = 'UTC'</code> line before calling <code>time.tzset()</code>. However, since <code>time.tzset()</code> is not available in Windows, this line will have no effect.</p><p>So, if you&rsquo;re developing on Windows, you can simply remove the lines that set the timezone and use the <code>datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')</code> to get the current timestamp. This will give you the local system time without considering any timezone settings.</p><p>Here is the modified code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> requests
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> threading
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> datetime
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> os <span style=color:#f92672>import</span> getenv, environ
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configuration variables</span>
</span></span><span style=display:flex><span>TIME_BETWEEN_REQUESTS <span style=color:#f92672>=</span> int(getenv(<span style=color:#e6db74>&#34;TIME_BETWEEN_REQUESTS&#34;</span>, <span style=color:#ae81ff>5</span>))  <span style=color:#75715e># in seconds</span>
</span></span><span style=display:flex><span>AUTHORIZATION_KEY <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;AUTHORIZATION_KEY&#34;</span>)
</span></span><span style=display:flex><span>DATABASE_URL <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;DATABASE_URL&#34;</span>)
</span></span><span style=display:flex><span>TABLE_NAME <span style=color:#f92672>=</span> getenv(<span style=color:#e6db74>&#34;TABLE_NAME&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Trading212API</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, authorization_key):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>authorization_key <span style=color:#f92672>=</span> authorization_key
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_pies</span>(self):
</span></span><span style=display:flex><span>        url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://demo.rading212.com/api/v0/equity/pies&#34;</span>
</span></span><span style=display:flex><span>        headers <span style=color:#f92672>=</span> {<span style=color:#e6db74>&#34;Authorization&#34;</span>: self<span style=color:#f92672>.</span>authorization_key}
</span></span><span style=display:flex><span>        response <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>get(url, headers<span style=color:#f92672>=</span>headers)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> response<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DatabaseWriter</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, database_url, table_name):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>database_url <span style=color:#f92672>=</span> database_url
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>table_name <span style=color:#f92672>=</span> table_name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>write_data_to_db</span>(self, data):
</span></span><span style=display:flex><span>        conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(self(database_url))
</span></span><span style=display:flex><span>        cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> data:
</span></span><span style=display:flex><span>            now <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>now()<span style=color:#f92672>.</span>strftime(<span style=color:#e6db74>&#39;%Y-%m-</span><span style=color:#e6db74>%d</span><span style=color:#e6db74> %H:%M:%S&#39;</span>)  <span style=color:#75715e># Get current timestamp</span>
</span></span><span style=display:flex><span>            cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                INSERT INTO </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                 (id, cash, dividend_details, result, progress, status, inserted_at)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                VALUES (</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>, </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>             &#34;&#34;&#34;</span> <span style=color:#f92672>.</span>format(self<span style=color:#f92672>.</span>table_name),
</span></span><span style=display:flex><span>                          (item[<span style=color:#e6db74>&#39;id&#39;</span>], item[<span style=color:#e6db74>&#39;cash&#39;</span>], str(item[ <span style=color:#e6db74>&#39;dividendDetails&#39;</span>]), str(item[ <span style=color:#e6db74>&#39;result&#39;</span>]), item[<span style=color:#e6db74>&#39;progress&#39;</span>], item[<span style=color:#e6db74>&#39;status&#39;</span>], now))
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>commit()
</span></span><span style=display:flex><span>        conn<span style=color:#f92672>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>send_request_and_write_to_db</span>(api, db_writer):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> api<span style=color:#f92672>.</span>get_pies()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> data:
</span></span><span style=display:flex><span>            db_writer<span style=color:#f92672>.</span>write_data_to_db(data)
</span></span><span style=display:flex><span>        time<span style=color:#f92672>.</span>sleep(TIME_BETWEEN_REQUESTS)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    api <span style=color:#f92672>=</span> Trading212API(AUTHORIZATION_KEY)
</span></span><span style=display:flex><span>    db_writer <span style=color:#f92672>=</span> DatabaseWriter(DATABASE_URL, TABLE_NAME)
</span></span><span style=display:flex><span>    thread <span style=color:#f92672>=</span> threading<span style=color:#f92672>.</span>Thread(target<span style=color:#f92672>=</span>send_request_and_write_to_db, args<span style=color:#f92672>=</span>(api, db_writer))
</span></span><span style=display:flex><span>    thread<span style=color:#f92672>.</span>start()
</span></span></code></pre></div><p>This code should work as expected on both Unix and Windows.</p><hr><p><strong>One last task, can you help me write a docker compose file which will create a container to run our python code, a container for postgres (where our python script will insert to) including an init script to make the table, and a grafana instance? Can you include any environment variables which we will need to pass to our python script such as database_url and table_name</strong></p><hr><p>Here is a Docker Compose file that creates three containers: one for your Python script, one for PostgreSQL with an initial script to create the table, and one for Grafana:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>postgres</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_USER</span>: <span style=color:#ae81ff>myuser</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_PASSWORD</span>: <span style=color:#ae81ff>mypassword</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>POSTGRES_DB</span>: <span style=color:#ae81ff>mydatabase</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db-data:/var/lib/postgresql/data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>init-db</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>./init-db</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>python init.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>python-app</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>build</span>: <span style=color:#ae81ff>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>depends_on</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>db</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>DATABASE_URL</span>: <span style=color:#e6db74>&#34;postgresql://myuser:mypassword@db:5432/mydatabase&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>TABLE_NAME</span>: <span style=color:#e6db74>&#34;mytable&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>TIME_BETWEEN_REQUESTS</span>: <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AUTHORIZATION_KEY</span>: <span style=color:#e6db74>&#34;your-authorization-key&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>python app.py</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>grafana</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/grafana</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3000:3000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>db-data</span>:
</span></span></code></pre></div><p>Here&rsquo;s what this file does:</p><ol><li>It creates a <code>db</code> service that runs the official PostgreSQL image, sets environment variables for the user, password, and database name, and mounts a volume to persist data.</li><li>It creates an <code>init-db</code> service that builds from a directory named <code>init-db</code> in the current directory, depends on the <code>db</code> service, and runs a command to create the table using a Python script named <code>init.py</code>.</li><li>It creates a <code>python-app</code> service that builds from the current directory, depends on the <code>db</code> service, sets environment variables for the database URL, table name, time between requests, and authorization key, and runs the command to start the Python app.</li><li>It creates a <code>grafana</code> service that runs the official Grafana image, exposes port 3000, and restarts always.</li></ol><p>To use this file, create a directory named <code>init-db</code> in the same directory as your Docker Compose file, and add an <code>init.py</code> script to it with the following contents:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> psycopg2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>conn <span style=color:#f92672>=</span> psycopg2<span style=color:#f92672>.</span>connect(
</span></span><span style=display:flex><span>    host<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;localhost&#34;</span>,
</span></span><span style=display:flex><span>    database<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mydatabase&#34;</span>,
</span></span><span style=display:flex><span>    user<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;myuser&#34;</span>,
</span></span><span style=display:flex><span>    password<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;mypassword&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>cur <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span>cursor()
</span></span><span style=display:flex><span>cur<span style=color:#f92672>.</span>execute(<span style=color:#e6db74>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    CREATE TABLE IF NOT EXISTS mytable (
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        id SERIAL PRIMARY KEY,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        cash REAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        dividend_details TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        result REAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        progress REAL,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        status TEXT,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        inserted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    );
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;&#34;&#34;</span>)
</span></span><span style=display:flex><span>conn<span style=color:#f92672>.</span>commit()
</span></span></code></pre></div><p>This script connects to the PostgreSQL database, creates a table named <code>mytable</code> with the specified columns if it doesn&rsquo;t exist, and commits the changes.</p><p>Then, you can run <code>docker-compose up -d</code> in your terminal to start all services in detached mode.</p><hr><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>The responses are very fast and accurate, the model takes care to consider all aspects of the prompt and for the most part holds onto the context of the conversation. When I pivoted towards asking about Docker configurations, things started to fall apart and mistakes were introduced. For example our postgres init script was never going to run without a Dockerfile and the practice of splitting this out into a stand alone services makes the deployment less idempotent. The robots won&rsquo;t be taking out jobs just yet&mldr;</p><figure><img loading=lazy src=/images/sad-robot.png alt="They didn&rsquo;t take our jerbs&mldr; yet"><figcaption><p>They didn&rsquo;t take our jerbs&mldr; yet</p></figcaption></figure><p>Ultimately, I reach the token count and the responses started to drop previously fixed sections of code. This is a common issue with all LLM services and one that Clause 3 looks to solve with enormous context token values&mldr; unfortunately this could get very expensive due to the token based pricing structure.</p><p>The people of the LM Studio discord server are begging for RAG type document referencing features, which would be great. But, relatively small context token counts will mean that this feature could quickly lead to model confusion.</p><h3 id=tldr>TLDR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h3><p><strong>Llama3 is another step in the right direction and LM Studio once again proves to be an exceptional demonstration of free open source software, but there is always more work to be done</strong></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://exitcode0.net/tags/stable-diffusion/>Stable-Diffusion</a></li><li><a href=https://exitcode0.net/tags/ai/>AI</a></li><li><a href=https://exitcode0.net/tags/art/>Art</a></li></ul><nav class=paginav><a class=prev href=https://exitcode0.net/posts/home-assistant-firehd8-dashboard/><span class=title>« Prev</span><br><span>Using an Amazon FireHD8 as a Home Assistant Dashboard Control Panel</span>
</a><a class=next href=https://exitcode0.net/posts/generating-artwork-with-stable-diffusion-april-2024/><span class=title>Next »</span><br><span>Generating Artwork With Stable Diffusion - April 2024 Edition</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://exitcode0.net/>ExitCode0</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>